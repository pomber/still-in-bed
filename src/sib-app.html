<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="sib-sun.html">
<link rel="import" href="sib-cloud.html">

<dom-module id="sib-app">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
        background-color: var(--paper-blue-300);
      }

      .sky {
        height: 250px; 
        position: relative;
        margin-bottom: 50px;
      }

      sib-sun {
        position: absolute;
        top: 10%;
        left: 5%;
        z-index: 20;
        --sky-sun-size: 150px;
      }

      sib-cloud.one {
        position: absolute;
        top: 15%;
        right: 5%;
        z-index: 40;
        --sky-cloud-size: 80px;
      }

      sib-cloud.two {
        position: absolute;
        top: 70%;
        left: 35%;
        z-index: 40;
      }

      paper-button {
        color: white;
      }

      .log-button {
        color: white;
        height: 100px;
        width: 100px;
        font-size: x-large;
      }

      .time {
        color: white;
        font-size: 5em;
      }

      .day {
        color: white;
        border: 1px;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 8px;
        border-width: 2px;
        border-style: solid;
        margin: 3px;
        padding: 4px;
      }

      .day .t {
        font-size: 1.5em;
      }
    </style>

    <app-localstorage-document log
      key="sib-prod" data="{{list}}">
    </app-localstorage-document>

    <div class="sky">
      <sib-sun></sib-sun>
      <sib-cloud class="one"></sib-cloud>
      <sib-cloud class="two"></sib-cloud>
    </div>

    <div class="layout vertical center">
      
      <div class="time" hidden$="[[todaysTime]]">
        [[time]]
      </div>
      <div class="time" hidden$="[[!todaysTime]]">
        [[todaysTime]]
      </div>

      <paper-icon-button 
        icon="icons:alarm-on" class="log-button" on-tap="log">
      </paper-icon-button>
      
      <div class="layout horizontal center">
        <div class="layout vertical center day">
          <div class="t">07:30</div>
          <div>MAR 20</div>
        </div>
        <div class="layout vertical center day">
          <div class="t">08:21</div>
          <div>MAR 21</div>
        </div>
        <div class="layout vertical center day">
          <div class="t">-</div>
          <div>MAR 22</div>
        </div>
        <div class="layout vertical center day">
          <div class="t">08:15</div>
          <div>MAR 23</div>
        </div>
      </div>
      <paper-button>More stats..</paper-button>
    </div>

  </template>

  <script>
    Polymer({

      is: 'sib-app',

      properties: {
        list: {
          type: Array,
          value: []
        },
        time: String,
        todaysTime: String,
        today: Object, 
      },

      observers: [
        'onChange(list, list.splices, today)'
      ],

      ready: function() {
        this.async(this.tick);
      },

      tick: function() {        
        var newTime = this._getTime(new Date());

        if (!this.time || newTime < this.time) {
          this.today = new Date();
        }

        this.time = newTime;
        this.async(this.tick, 1000);       

        //HACK observer is not working
        this.onChange(); 
      },

      onChange: function() {        
        var lastDate = this._getLastDate();
        if (lastDate && this._isToday(lastDate)) {
          this.todaysTime = this._getTime(lastDate);
        } else {
          this.todaysTime = null;
        }
      },

      log: function() {
        var item = { time: new Date().toISOString() };
        this.push("list", item);
        console.log(item);
      },

      _getLastDate: function() {
        var last = this.list.slice(-1).pop();
        if (!last) return null;
        return new Date(last.time);
      },

      _getTime: function(date) {
        return date.toTimeString().split(" ")[0];
      },

      _isToday: function(date) {
        var now = new Date();
        return now.toDateString() == date.toDateString();
      },

    });
  </script>
</dom-module>
