<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="sib-days">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {}
      
      .tile {
        color: white;
        border: 1px;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 8px;
        border-width: 2px;
        border-style: solid;
        margin: 3px;
        padding: 4px;
        text-transform: uppercase;
      }
      
      .day .top {
        font-size: 1.5em;
      }

      .button {
        height: 60px;
        width: 75px;
        background-color: white;
        color: var(--paper-blue-300);
        cursor: pointer;
      }

      .button .top {
        font-size: 1.3em;
      }

      .button .top.done {
        font-size: 1.8em;
      }
    </style>

    <div class="layout horizontal center">
      <template is="dom-repeat" items="[[days]]">
        <div class="layout vertical center day tile">
          <div class="top">[[item.time]]</div>
          <div>[[item.month]] [[item.day]]</div>
        </div>
      </template>
      <div class="layout vertical center center-justified button tile" on-tap="track">
        <div class="top" hidden$="[[today.done]]">I'm up!</div>
        <div class="top done" hidden$="[[!today.done]]">[[today.time]]</div>
        <div>[[today.month]] [[today.day]]</div>
      </div>
    </div>

  </template>

  <script>
    Polymer({

      is: 'sib-days',

      properties: {
        list: Array,
        days: {
          type: Array,
          computed: 'getDays(list.splices)',
        },
        today: {
          type: Object,
          computed: 'getToday(list.splices)',
        },
      },

      getDays: function() {
        var self = this;

        var days = []
        var today = new Date();
        for (var i = -3; i <= 0; i++) {
          var day = new Date(today);
          day.setDate(today.getDate() + i);
          days.push(day);
        }

        // return days.map(function (date) {
        //   return self._getInfo(date);
        // });

        var last = self.list.slice(-1)[0];
        if (!last) return [];

        var lastDate = new Date(last.time);
        var dates = self._isToday(lastDate) ?
          this.list.slice(-4, -1):
          this.list.slice(-3);          

        return dates.map(function (item) {
          var date = new Date(item.time);
          return self._getInfo(date);
        })
      },

      getToday: function() {
        var last = this.list.slice(-1)[0];
        var lastDate = last && new Date(last.time);
        
        if (this._isToday(lastDate)) {
          return this._getInfo(lastDate);
        }

        var date = new Date();
        var info = this._getInfo(date, true);
        return info;
      },

      track: function() {
        if (!this.today.done) {
          this.fire("track");
        }
      },

      _getInfo: function(date, missing) {
        return {
          month: date.toString().split(" ")[1],
          day: date.getDate(),
          time: this._getTime(date),
          done: !missing
        };     
      },

      _getTime: function(date) {        
        return date.toTimeString().split(" ")[0].slice(0, 5);
      },

      _isToday: function(date) {
        if (!date) return false;
        var now = new Date();
        return now.toDateString() == date.toDateString();
      },

    });
  </script>
</dom-module>