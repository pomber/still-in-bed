<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="sib-sparkline">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        color: white;
        display: block;
        width: 100%;
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        @apply(--layout-center);
      }

      .axis {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-center);
        width: 100%;
        background-color: var(--primary-color);
        padding: 10px 0;
      }

      .label {
        @apply(--paper-font-common-base);
        font-size: 16px;
        font-weight: 400;
        opacity: 0.8;
        width: 14%;
        height: 20px;
        text-align: center;
      }

      .date {
        text-align: center;
        opacity: 0.8;
      }

      svg {
        width: 100vw;
        height: 100vh;
        position: fixed;
        bottom: 0;
      }

      svg path {
        stroke-opacity: 0.7;
        stroke: white;
        fill: var(--primary-color);
        stroke-width: 1;
        stroke-linejoin: round;
      }

      svg circle {
        r: 1;
        fill: white;
        fill-opacity: 0.7;
        stroke: white;
        stroke-width: 2.5;
        stroke-opacity: 0.3;
      }

      svg line {
        --stroke: url(#grad);
        stroke: white;
        stroke-width: 0.4;
        stroke-opacity: 0.7;
      }

      stop.start {
        stop-opacity: 0;  
        stop-color: white;
      }

      stop.end {
        stop-opacity: 0.9;  
        stop-color: white;
      }

      svg text {
        @apply(--paper-font-common-base);
        font-size: 5px;
        font-weight: 400;
        fill: white;
        fill-opacity: 0.8;
        text-anchor: start;
      }

      svg text.mute {
        fill-opacity: 0.5;
      }
    </style>
    <svg id="svg"
      xmlns="http://www.w3.org/2000/svg" version="1.1" 
      viewBox="0 -1 100 1" preserveAspectRatio="xMidYMax" on-tap="tap">
      <defs>
        <linearGradient id="grad" gradientUnits="userSpaceOnUse">
          <stop class="start" offset="50%"/>
          <stop class="end" offset="100%"/>
        </linearGradient>
      </defs>
      
<path d="M-5 -22 C1.5 -22 1.5 -22 8 -22 C15 -22 15 -34 22 -34 C29 -34 29 -16 36 -16 C43 -16 43 -65.8 50 -65.8 C57 -65.8 57 -76 64 -76 C71 -76 71 -52 78 -52 C85 -52 85 -46 92 -46 h100 v500 h-500"></path>
<circle cx="8" cy="-22"></circle>
<circle cx="22" cy="-34"></circle>
<circle cx="36" cy="-16"></circle>
<circle cx="50" cy="-65.8"></circle>
<circle cx="64" cy="-76"></circle>
<circle cx="78" cy="-52"></circle>
<circle cx="92" cy="-46"></circle>

      <line x1="36" x2="36" y1="-15" y2="-100"></line>
      <text x="36" y="-100" dx="1" dy="3">07:10</text>
      <text x="36" y="-100" dx="1" dy="8" class="mute">wed</text>

      <line x1="64" x2="64" y1="-85" y2="-110"></line>
      <text x="64" y="-110" dx="1" dy="3">08:40</text>
      <text x="64" y="-110" dx="1" dy="8" class="mute">fri</text>

<!--      
      <text x$="[[xmax(coords.*)]]" y$="[[ymax(coords.*)]]" dy="-9">08:55</text>
      <text x$="[[xmin(coords.*)]]" y$="[[ymin(coords.*)]]" dy="-30">07:10</text>
      -->
      <!--<line x1="72" x2="82" y1="60" y2="60"></line>-->
    </svg>

    <div class="axis">      
      <template is="dom-repeat" items="[[coords]]">
        <span class="label">[[item.l]]</span>
      </template>              
    </div>

  </template>

  <script>
    Polymer({

      is: 'sib-sparkline',

      ready: function() {
        var cs = [
          { x:  8, y: 10 },
          { x: 22, y: 30 },
          { x: 36, y: 0 },
          { x: 50, y: 83 },
          { x: 64, y: 100 },
          { x: 78, y: 60 },
          { x: 92, y: 50 },
        ];

        var b = 16;
        var k = 60;

        cs.forEach(function (c, i) {
          c.y = -b - (k*c.y/100);
        });

        console.groupCollapsed("SVG");
        var output = "";
        
        var d = this.getPath(cs);
        var p = "<path d=\"" + d + "\"></path>";
        
        console.log(p);
        output += p + "\n";

        cs.forEach(function (c) {
          var e = "<circle cx=\"" 
            + c.x + "\" cy=\""+ c.y 
            + "\"></circle>";
          console.log(e);
          output += e + "\n";
        });   

        console.groupEnd();
        console.log(output);
      },

      getPath: function(cs) {
        var y0 = cs[0].y;
        var i = 0;
        while(!y0 && i < cs.length) {
          y0 = cs[i++].y;
        }

        if (!y0) return ''; 

        var path = 'M-5 ' + y0;
        var prev = {x: -5, y: y0};

        for (var i = 0; i < cs.length; i++) {
          var c = cs[i];
          if (!c.y) continue;

          path += ' C'
            + (prev.x + c.x) / 2 + ' ' + prev.y + ' '
            + (prev.x + c.x) / 2 + ' ' + c.y + ' ' 
            + c.x + ' ' + c.y;

          prev = c;
        }

        path += ' h100 v500 h-500';
        //console.log(path);
        return path;
      }

    });
  </script>
</dom-module>